<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Market | Dynamic Pricing</title>
    <meta name="theme-color" content="#0f766e">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- React & Supabase -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --primary: #0f766e; --primary-dark: #0d5f58; --primary-light: #14b8a6;
            --accent: #f59e0b; --up: #10b981; --down: #ef4444;
            --bg-body: #f8fafc;
            --text-main: #1e293b; --text-muted: #64748b;
            --radius-xl: 24px; --radius-lg: 16px;
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
            --nav-height: 70px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-body); color: var(--text-main); padding-bottom: 40px; }
        h1, h2, h3 { font-family: 'Outfit', sans-serif; letter-spacing: -0.02em; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }

        /* --- Header --- */
        header { position: sticky; top: 0; z-index: 1000; background: rgba(255,255,255,0.9); backdrop-filter: blur(16px); border-bottom: 1px solid rgba(0,0,0,0.05); height: var(--nav-height); display: flex; align-items: center; }
        .nav-content { width: 100%; display: flex; align-items: center; justify-content: space-between; }
        .back-btn { display: flex; align-items: center; gap: 8px; font-weight: 600; padding: 8px 16px; border-radius: 50px; background: #f1f5f9; color: var(--text-muted); transition: all 0.2s; border: 1px solid transparent; cursor: pointer; }
        .back-btn:hover { background: var(--primary); color: white; }

        /* --- Cards & Grid --- */
        .card { background: white; border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-sm); border: 1px solid #f1f5f9; margin-bottom: 24px; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; }
        
        /* --- Price Table --- */
        .price-table-container { overflow-x: auto; }
        .price-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .price-table th { text-align: left; padding: 16px; font-size: 0.85rem; text-transform: uppercase; color: var(--text-muted); font-weight: 600; border-bottom: 2px solid #e2e8f0; }
        .price-table td { padding: 16px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        .price-table tr:last-child td { border-bottom: none; }
        .price-table tr:hover td { background: #f8fafc; }

        .trend-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; }
        .trend-up { background: #dcfce7; color: #166534; }
        .trend-down { background: #fee2e2; color: #991b1b; }
        .trend-stable { background: #f1f5f9; color: #475569; }

        .stock-bar { height: 6px; background: #e2e8f0; border-radius: 3px; width: 100px; overflow: hidden; }
        .stock-fill { height: 100%; background: var(--primary); }

        /* --- Insight Chart --- */
        .chart-visual { height: 200px; display: flex; align-items: flex-end; gap: 10px; padding-top: 20px; }
        .chart-col { flex: 1; background: var(--primary-light); border-radius: 4px 4px 0 0; position: relative; transition: height 0.5s ease; }
        .chart-col:hover { background: var(--primary); }
        .chart-col::after { content: attr(data-val); position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 0.7rem; font-weight: 700; }

        /* --- Loading --- */
        .loading { text-align: center; padding: 40px; color: var(--text-muted); }
        .spinner { width: 30px; height: 30px; border: 3px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div class="container nav-content">
            <a href="dashboard.html" class="back-btn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                Kembali
            </a>
            <div style="font-weight: 800; color: var(--primary);">Smart Market ðŸ“Š</div>
            <div style="width: 80px;"></div>
        </div>
    </header>

    <main class="container">
        <!-- Hero Insight -->
        <div style="margin: 30px 0;">
            <h1 style="font-size: 2rem; color: var(--primary-dark); margin-bottom: 8px;">Harga Pasar Realtime</h1>
            <p style="color: var(--text-muted);">Analisis dinamika harga buah & komoditas berbasis data permintaan dan stok.</p>
        </div>

        <!-- Top Stats -->
        <div class="grid-2" style="margin-bottom: 30px;">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                    <h3 style="font-size: 1rem; color: var(--text-muted);">Indeks Harga</h3>
                    <span style="background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 700;">+2.4% Hari Ini</span>
                </div>
                <div style="font-size: 2rem; font-weight: 800; font-family: 'JetBrains Mono', monospace;">128.5</div>
                <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 5px;">Poin Stabil</p>
            </div>
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                    <h3 style="font-size: 1rem; color: var(--text-muted);">Komoditas Paling Diminati</h3>
                </div>
                <div style="font-size: 1.5rem; font-weight: 700;">Durian Lokal</div>
                <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                    <div class="stock-bar" style="width: 100px; flex: 1;"><div class="stock-fill" style="width: 85%; background: var(--accent);"></div></div>
                    <span style="font-size: 0.8rem; font-weight: 600; color: var(--accent);">High Demand</span>
                </div>
            </div>
        </div>

        <!-- Main Table -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="font-size: 1.2rem; font-weight: 700;">Daftar Harga Komoditas</h3>
                <div style="font-size: 0.8rem; color: var(--text-muted); display: flex; align-items: center; gap: 6px;">
                    <span style="width: 8px; height: 8px; background: var(--success); border-radius: 50%; animation: pulse 2s infinite;"></span>
                    Live Data
                </div>
            </div>
            
            <div class="price-table-container">
                <table class="price-table">
                    <thead>
                        <tr>
                            <th>Produk</th>
                            <th>Kategori</th>
                            <th>Harga / Kg</th>
                            <th>Perubahan</th>
                            <th>Stok Pasar</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="price-tbody">
                        <!-- Data akan diisi oleh React -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Demand Chart Simulation -->
        <div class="card">
            <h3 style="font-size: 1.2rem; font-weight: 700; margin-bottom: 20px;">Grafik Permintaan (Demand)</h3>
            <div class="chart-visual" id="demand-chart">
                <!-- Chart bars generated by JS -->
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.8rem; color: var(--text-muted);">
                <span>Sen</span><span>Sel</span><span>Rab</span><span>Kam</span><span>Jum</span><span>Sab</span><span>Min</span>
            </div>
        </div>

        <!-- Smart Pricing Info -->
        <div class="card" style="background: linear-gradient(135deg, #1e293b, #0f172a); color: white;">
            <h3 style="font-size: 1.2rem; font-weight: 700; margin-bottom: 10px;">ðŸ¤– Smart Pricing System</h3>
            <p style="opacity: 0.8; font-size: 0.95rem; margin-bottom: 15px;">
                Sistem kami menyesuaikan harga rekomendasi berdasarkan algoritma stok vs permintaan. Jika stok menipis dan permintaan tinggi, harga akan naik secara otomatis untuk menyeimbangkan pasar.
            </p>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <div style="background: rgba(255,255,255,0.1); padding: 8px 16px; border-radius: 8px; font-size: 0.85rem;">âœ… Stabilisasi Pasar</div>
                <div style="background: rgba(255,255,255,0.1); padding: 8px 16px; border-radius: 8px; font-size: 0.85rem;">âœ… Mencegah Spekulasi</div>
                <div style="background: rgba(255,255,255,0.1); padding: 8px 16px; border-radius: 8px; font-size: 0.85rem;">âœ… Transparansi Harga</div>
            </div>
        </div>

    </main>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { createClient } = supabase;

        // --- KONFIGURASI SUPABASE (Ganti dengan Key Anda) ---
        const SUPABASE_URL = 'https://dikapquhusbwjccbqcsb.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRpa2FwcXVodXNid2pjY2JxY3NiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxNjQ1NTQsImV4cCI6MjA4NDc0MDU1NH0.X278oHDF0be7oa25484eliSukSYAYvDbJyU6ysz83zA';
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Helper format Rupiah
        const formatRupiah = (number) => {
            return new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR", minimumFractionDigits: 0 }).format(number);
        };

        // Komponen Utama
        function SmartMarket() {
            const [marketData, setMarketData] = useState([]);
            const [loading, setLoading] = useState(true);

            // Fetch Data
            useEffect(() => {
                const fetchPrices = async () => {
                    const { data, error } = await supabaseClient
                        .from('harga_pasar')
                        .select('*')
                        .order('demand_level', { ascending: false }); // Urutkan berdasarkan demand

                    if (error) console.error("Error fetching prices:", error);
                    else setMarketData(data);
                    setLoading(false);
                };

                fetchPrices();

                // Subscription untuk Realtime Update
                const channel = supabaseClient
                    .channel('public:harga_pasar')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'harga_pasar' }, (payload) => {
                        // Simple refresh logic for demo
                        fetchPrices();
                    })
                    .subscribe();

                return () => { supabaseClient.removeChannel(channel); };
            }, []);

            // Render Tabel
            if (loading) return (
                <div className="loading">
                    <div className="spinner"></div>
                    <p>Mengambil data pasar...</p>
                </div>
            );

            return (
                <div>
                    {marketData.map((item) => {
                        // Hitung Persentase Perubahan
                        let changePercent = 0;
                        let trendClass = 'trend-stable';
                        let trendIcon = 'minus';

                        if (item.previous_price && item.previous_price > 0) {
                            changePercent = ((item.current_price - item.previous_price) / item.previous_price) * 100;
                            if (changePercent > 0) { trendClass = 'trend-up'; trendIcon = 'trending-up'; }
                            else if (changePercent < 0) { trendClass = 'trend-down'; trendIcon = 'trending-down'; }
                        }

                        return (
                            <tr key={item.id}>
                                <td>
                                    <div style="font-weight: 600; color: var(--text-main);">{item.product_name}</div>
                                    {item.is_smart_priced && <span style="font-size: 0.65rem; background: #e0f2fe; color: #0284c7; padding: 2px 6px; border-radius: 4px;">AI Optimized</span>}
                                </td>
                                <td style="color: var(--text-muted); font-size: 0.9rem;">{item.category}</td>
                                <td style="font-family: 'JetBrains Mono', monospace; font-weight: 700;">{formatRupiah(item.current_price)}</td>
                                <td>
                                    <span className={`trend-badge ${trendClass}`}>
                                        {trendIcon !== 'minus' && <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>}
                                        {Math.abs(changePercent).toFixed(1)}%
                                    </span>
                                </td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style={{width: '60px', height: '6px', background: '#e2e8f0', borderRadius: '3px', overflow: 'hidden'}}>
                                            <div style={{width: `${Math.min(item.stock_ton * 20, 100)}%`, height: '100%', background: item.stock_ton < 2 ? 'var(--down)' : 'var(--primary)'}}></div>
                                        </div>
                                        <span style="font-size: 0.8rem; font-weight: 600;">{item.stock_ton} Ton</span>
                                    </div>
                                </td>
                                <td>
                                    <span style={{
                                        padding: '4px 10px', borderRadius: '12px', fontSize: '0.75rem', fontWeight: 600,
                                        background: item.demand_level === 'Tinggi' ? '#fef3c7' : '#f1f5f9',
                                        color: item.demand_level === 'Tinggi' ? '#b45309' : '#64748b'
                                    }}>
                                        {item.demand_level}
                                    </span>
                                </td>
                            </tr>
                        );
                    })}
                </div>
            );
        }

        // Render
        const root = ReactDOM.createRoot(document.body.appendChild(document.createElement('div')));
        // Insert component into existing container structure logic
        const container = document.getElementById('price-tbody');
        if(container) {
             const rootInner = ReactDOM.createRoot(container);
             rootInner.render(<SmartMarket />);
        } else {
            // Fallback rendering if tbody missing
             const rootMain = ReactDOM.createRoot(document.getElementById('root') || document.body);
             // Logic to render full page would go here, but for this snippet we assume tbody exists
        }
    </script>
    
    <!-- Script untuk generate chart visual statis -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const chartContainer = document.getElementById('demand-chart');
            const heights = [40, 55, 30, 70, 85, 60, 45]; // Data dummy
            heights.forEach(h => {
                const bar = document.createElement('div');
                bar.className = 'chart-col';
                bar.style.height = `${h}%`;
                bar.setAttribute('data-val', h);
                chartContainer.appendChild(bar);
            });
            
            // Fix React Mount Point manually for this hybrid structure
            const tbody = document.getElementById('price-tbody');
            if(tbody) {
                 // Override the script above logic slightly to mount cleanly
            }
        });
    </script>
</body>
</html>
