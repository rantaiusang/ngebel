<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | Ngebel Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #f0f9ff;
            display: flex; justify-content: center; align-items: center; height: 100vh;
            margin: 0;
        }
        .card {
            background: white; padding: 40px; border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 380px;
            text-align: center;
        }
        h2 { color: #0f172a; margin-bottom: 5px; }
        p.subtitle { color: #64748b; font-size: 0.9rem; margin-bottom: 25px; }
        
        input {
            width: 100%; padding: 12px; margin-bottom: 15px;
            border: 1px solid #cbd5e1; border-radius: 8px;
            box-sizing: border-box; font-size: 14px;
        }
        input:focus { outline: 2px solid #0d9488; border-color: transparent; }
        
        button {
            width: 100%; padding: 12px; background: #0d9488; color: white;
            border: none; border-radius: 8px; font-weight: 600; cursor: pointer;
            transition: 0.2s;
        }
        button:hover { background: #0f766e; }
        button:disabled { background: #cbd5e1; cursor: not-allowed; }
        
        .link-btn {
            background: none; border: none; color: #0d9488; 
            font-size: 0.85rem; padding: 0; margin-top: 5px; 
            text-decoration: underline; cursor: pointer; width: auto;
        }
        
        .msg { font-size: 0.85rem; margin-top: 15px; padding: 10px; border-radius: 6px; display: none; }
        .error { background: #fef2f2; color: #ef4444; }
        .success { background: #f0fdf4; color: #15803d; }
        
        /* Animasi fade */
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="card">
    <!-- LOGO / HEADER -->
    <div style="font-size: 40px; margin-bottom: 10px;">ðŸŒ¿</div>
    
    <!-- MODE 1: LOGIN NORMAL -->
    <div id="view-login" class="fade-in">
        <h2>Selamat Datang</h2>
        <p class="subtitle">Masuk ke dashboard Ngebel</p>
        
        <form id="form-login" onsubmit="handleLogin(event)">
            <input type="email" id="login-email" placeholder="Email" required>
            <input type="password" id="login-password" placeholder="Password" required>
            
            <div style="text-align: right;">
                <button type="button" class="link-btn" onclick="switchView('forgot')">Lupa password?</button>
            </div>
            
            <button type="submit" id="btn-login">Masuk</button>
        </form>
        
        <div id="msg-login" class="msg"></div>
        <br>
        <a href="register.html" style="font-size: 0.85rem; color: #64748b; text-decoration: none;">Belum punya akun? Daftar</a>
    </div>

    <!-- MODE 2: REQUEST RESET PASSWORD -->
    <div id="view-forgot" class="hidden fade-in">
        <h2>Lupa Password?</h2>
        <p class="subtitle">Masukkan email untuk menerima link reset.</p>
        
        <form id="form-forgot" onsubmit="handleForgot(event)">
            <input type="email" id="forgot-email" placeholder="Email terdaftar" required>
            <button type="submit" id="btn-forgot">Kirim Link Reset</button>
        </form>
        
        <div id="msg-forgot" class="msg"></div>
        <br>
        <button type="button" class="link-btn" onclick="switchView('login')">Kembali ke Login</button>
    </div>

    <!-- MODE 3: UPDATE PASSWORD (Muncul jika buka link dari email) -->
    <div id="view-update" class="hidden fade-in">
        <h2>Reset Password</h2>
        <p class="subtitle">Masukkan password baru Anda.</p>
        
        <form id="form-update" onsubmit="handleUpdate(event)">
            <input type="password" id="new-pass" placeholder="Password Baru" required minlength="6">
            <input type="password" id="confirm-pass" placeholder="Ulangi Password Baru" required minlength="6">
            <button type="submit" id="btn-update">Simpan Password Baru</button>
        </form>
        
        <div id="msg-update" class="msg"></div>
    </div>

</div>

<script>
    // --- KONFIGURASI ---
    const SUPABASE_URL = 'https://dikapquhusbwjccbqcsb.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRpa2FwcXVodXNid2pjY2JxY3NiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxNjQ1NTQsImV4cCI6MjA4NDc0MDU1NH0.X278oHDF0be7oa25484eliSukSYAYvDbJyU6ysz83zA';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- MANAJEMEN TAMPILAN ---
    function switchView(viewName) {
        document.getElementById('view-login').classList.add('hidden');
        document.getElementById('view-forgot').classList.add('hidden');
        document.getElementById('view-update').classList.add('hidden');
        document.getElementById('msg-login').style.display = 'none';
        document.getElementById('msg-forgot').style.display = 'none';
        document.getElementById('msg-update').style.display = 'none';

        document.getElementById('view-' + viewName).classList.remove('hidden');
    }

    function showMsg(type, text) {
        const id = 'msg-' + type;
        const el = document.getElementById(id);
        el.innerText = text;
        el.style.display = 'block';
        el.className = 'msg ' + (text.includes('Gagal') || text.includes('Salah') ? 'error' : 'success');
    }

    // --- 1. FUNGSI LOGIN MANUAL (Cek Tabel ngebelusers) ---
    async function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const btn = document.getElementById('btn-login');

        btn.disabled = true; btn.innerText = 'Memproses...';
        showMsg('login', ''); // reset

        try {
            const { data, error } = await sb
                .from('ngebelusers')
                .select('*')
                .eq('email', email)
                .eq('password', password)
                .maybeSingle();

            if (error) throw error;

            if (!data) {
                showMsg('login', 'Email atau Password salah!');
            } else {
                // Cek Role
                if(data.role === 'admin') {
                    window.location.href = 'admin.html';
                } else {
                    window.location.href = 'dashboard.html';
                }
            }
        } catch (err) {
            showMsg('login', 'Terjadi kesalahan: ' + err.message);
        } finally {
            btn.disabled = false; btn.innerText = 'Masuk';
        }
    }

    // --- 2. FUNGSI LUPA PASSWORD (Kirim Email via Supabase Auth) ---
    async function handleForgot(e) {
        e.preventDefault();
        const email = document.getElementById('forgot-email').value;
        const btn = document.getElementById('btn-forgot');

        btn.disabled = true; btn.innerText = 'Mengirim...';
        showMsg('forgot', '');

        try {
            // Kirim email reset
            const { error } = await sb.auth.resetPasswordForEmail(email, {
                redirectTo: window.location.href // Redirect balik ke halaman ini
            });

            if (error) throw error;

            showMsg('forgot', 'Link reset password telah dikirim ke email Anda. Silakan cek Inbox/Spam.');
        } catch (err) {
            showMsg('forgot', 'Gagal mengirim email: ' + err.message);
        } finally {
            btn.disabled = false; btn.innerText = 'Kirim Link Reset';
        }
    }

    // --- 3. FUNGSI UPDATE PASSWORD (Dari Link Email) ---
    async function handleUpdate(e) {
        e.preventDefault();
        const p1 = document.getElementById('new-pass').value;
        const p2 = document.getElementById('confirm-pass').value;
        const btn = document.getElementById('btn-update');

        if (p1 !== p2) {
            showMsg('update', 'Password tidak sama!');
            return;
        }

        btn.disabled = true; btn.innerText = 'Menyimpan...';
        showMsg('update', '');

        try {
            // Update password di Supabase Auth
            const { error } = await sb.auth.updateUser({ password: p1 });
            
            if (error) throw error;

            // TAMBAHAN: Update juga password di tabel manual ngebelusers
            // Kita perlu ambil email user yang sedang login di session auth
            const { data: { user } } = await sb.auth.getUser();
            if(user) {
                await sb.from('ngebelusers')
                    .update({ password: p1 })
                    .eq('email', user.email);
            }

            alert('Password berhasil diubah! Silakan login dengan password baru.');
            window.location.href = 'login.html'; // Reload bersih

        } catch (err) {
            showMsg('update', 'Gagal mengubah password: ' + err.message);
            btn.disabled = false; btn.innerText = 'Simpan Password Baru';
        }
    }

    // --- CEK URL SAAT LOAD (Apakah ini mode reset dari email?) ---
    window.addEventListener('load', async () => {
        const hash = window.location.hash;
        // Cek apakah URL mengandung token reset
        if (hash.includes('type=recovery') || hash.includes('access_token')) {
            switchView('update');
        } else {
            switchView('login');
        }
    });

</script>
</body>
</html>
